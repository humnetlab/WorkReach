---
title: "Job Location Utility Map"
jupyter: python3
---

## Setup

```{python}
import geopandas as gpd
import warnings
from utils import *

warnings.filterwarnings('ignore')
```

## Configuration

```{python}
CLOSE_JOB_IDX = 11
FAR_JOB_IDX = 40

PLOT_SIZE_KM = 10
CLOSE_REGIME_RADIUS_M = 3000
```

## Load Data

```{python}
# Load geodataframe with economic complexity data
gdf = gpd.read_file(
    "../../data/cdmx_map_informality_eci.geojson"
)
```

## Data Processing

Compute utilities, select home and job locations.

```{python}
zoom_gdf, home_coords, job_locations, zoom_bounds = process_utility_data(
    gdf=gdf,
    close_regime_radius=CLOSE_REGIME_RADIUS_M,
    close_job_idx=CLOSE_JOB_IDX,
    far_job_idx=FAR_JOB_IDX,
    plot_size=PLOT_SIZE_KM,
    random_state=42
)
```

## Visualizations

### Map 1: Economic Complexity Index (ECI)

```{python}
fig1, ax1 = plot_utility_map(
    zoom_gdf=zoom_gdf,
    home_coords=home_coords,
    job_locations=job_locations,
    zoom_bounds=zoom_bounds,
    close_regime_radius=CLOSE_REGIME_RADIUS_M,
    column='eci',
    cmap='viridis',
    figsize=(15, 15)
)
```

### Map 2: Utility Distribution (Viridis)

```{python}
fig2, ax2 = plot_utility_map(
    zoom_gdf=zoom_gdf,
    home_coords=home_coords,
    job_locations=job_locations,
    zoom_bounds=zoom_bounds,
    close_regime_radius=CLOSE_REGIME_RADIUS_M,
    column='utility',
    cmap='viridis',
    figsize=(15, 15)
)
```

### Map 3: Utility Distribution (Plasma - Final)

```{python}
fig3, ax3 = plot_utility_map(
    zoom_gdf=zoom_gdf,
    home_coords=home_coords,
    job_locations=job_locations,
    zoom_bounds=zoom_bounds,
    close_regime_radius=CLOSE_REGIME_RADIUS_M,
    column='utility',
    cmap='plasma',
    figsize=(15, 15),
    save_path='../../figs/cdmx_utility_job_location.png',
    dpi=300
)
```

## Summary Statistics

```{python}
print(f"Home location ECI: {zoom_gdf.loc[zoom_gdf['location_type'] == 'home', 'eci'].values[0]:.3f}")
print(f"\nSelected job locations:")
print(job_locations[['regime', 'utility', 'eci', 'distance_to_home']].to_string())
```

# Stacked Map

```{python}
gdf = gdf.loc[gdf["geomid"].str.startswith("09")].dropna()
```

```{python}
gdf = gdf
LAYERS = {
    'z_levels': [0.1, 0.6, 1.2],
    'columns': [
        'population',
        'eci',
        'informality_rate'
    ],
    'colormaps': [
        'YlOrRd',
        'viridis',
        'Blues'
    ]
}

CAMERA = {
    'elev': 30,
    'azim': -60
}
```


```{python}
fig, ax = create_3d_stacked_map(
    gdf=gdf,
    z_levels=LAYERS['z_levels'],
    columns=LAYERS['columns'],
    colormaps=LAYERS['colormaps'],
    # title="Stacked",
    figsize=(20, 20),
    alpha_min=0.1,
    alpha_max=0.7,
    elev=CAMERA['elev'],
    azim=CAMERA['azim'],
    # save_path='../../figs/cdmx_3d_stacked_main.png',
    dpi=300
)
```



```{python}
fig2, ax2 = create_3d_stacked_map(
    gdf=gdf,
    z_levels=LAYERS['z_levels'],
    columns=LAYERS['columns'],
    colormaps=LAYERS['colormaps'],
    title="",
    figsize=(20, 20),
    alpha_min=0.1,
    alpha_max=0.7,
    elev=45,
    azim=-45,
    # save_path='../../figs/cdmx_3d_stacked_alt1.png',
    dpi=300
)
```


```{python}
fig3, ax3 = create_3d_stacked_map(
    gdf=gdf,
    z_levels=LAYERS['z_levels'],
    columns=LAYERS['columns'],
    colormaps=LAYERS['colormaps'],
    title="",
    figsize=(20, 20),
    alpha_min=0.1,
    alpha_max=0.7,
    elev=20,
    azim=-90,
    # save_path='../../figs/cdmx_3d_stacked_side.png',
    dpi=300
)
```

## Layer Statistics

```{python}
print("Layer Statistics:")
print("=" * 60)

for i, col in enumerate(LAYERS['columns']):
    if col in gdf.columns:
        stats = gdf[col].describe()
        print(f"\nLayer {i+1}: {col.replace('_', ' ').title()}")
        print(f"  Z-level: {LAYERS['z_levels'][i]}")
        print(f"  Colormap: {LAYERS['colormaps'][i]}")
        print(f"  Mean: {stats['mean']:.2f}")
        print(f"  Std: {stats['std']:.2f}")
        print(f"  Min: {stats['min']:.2f}")
        print(f"  Max: {stats['max']:.2f}")
    else:
        print(f"\nLayer {i+1}: {col} - Column not found in data")
```